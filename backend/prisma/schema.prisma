// Prisma Schema para SplitApp

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ==================== USUARIOS ====================

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  password  String
  name      String
  avatar    String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relaciones - Grupos
  createdGroups   Group[]          @relation("GroupCreator")
  memberships     GroupMember[]
  guestsAdded     GuestMember[]    @relation("GuestAddedBy")
  expenses        Expense[]        @relation("ExpensePaidBy")
  expenseParticipations ExpenseParticipant[]
  debtsOwed       Debt[]           @relation("DebtFrom")
  debtsOwing      Debt[]           @relation("DebtTo")
  debtMarkedPaid  Debt[]           @relation("DebtMarkedPaidBy")
  guestDebtsOwed  GuestDebt[]      @relation("GuestDebtFromUser")
  guestDebtsOwing GuestDebt[]      @relation("GuestDebtToUser")
  wishListItems   WishListItem[]   @relation("WishListPurchasedBy")
  giftEvents      Event[]          @relation("GiftRecipient")
  refreshTokens   RefreshToken[]
  bankAliases     BankAlias[]
  pushTokens      PushToken[]

  // Relaciones - Billeteras (control de gastos personales)
  createdWallets     Wallet[]          @relation("WalletCreator")
  walletMemberships  WalletMember[]
  personalExpenses   PersonalExpense[] @relation("PersonalExpensePaidBy")
  customCategories   ExpenseCategory[] @relation("UserCategories")

  @@map("users")
}

// Alias bancarios para recibir transferencias
model BankAlias {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  alias     String   // El alias o CBU
  bankName  String?  // Nombre del banco (opcional)
  priority  Int      @default(1) // 1 = principal, 2 = secundario, 3 = terciario
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, priority]) // Solo un alias por prioridad por usuario
  @@map("bank_aliases")
}

model RefreshToken {
  id        String   @id @default(cuid())
  token     String   @unique
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  expiresAt DateTime
  createdAt DateTime @default(now())

  @@map("refresh_tokens")
}

// ==================== GRUPOS ====================

model Group {
  id          String   @id @default(cuid())
  name        String
  inviteCode  String   @unique
  createdById String
  createdBy   User     @relation("GroupCreator", fields: [createdById], references: [id])
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relaciones
  members      GroupMember[]
  guestMembers GuestMember[]
  events       Event[]

  @@map("groups")
}

model GroupMember {
  id       String   @id @default(cuid())
  userId   String
  user     User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  groupId  String
  group    Group    @relation(fields: [groupId], references: [id], onDelete: Cascade)
  joinedAt DateTime @default(now())

  @@unique([userId, groupId])
  @@map("group_members")
}

// Participantes manuales (sin cuenta) - ej: la abuela, t铆os, etc.
model GuestMember {
  id        String   @id @default(cuid())
  name      String
  groupId   String
  group     Group    @relation(fields: [groupId], references: [id], onDelete: Cascade)
  addedById String   // Usuario que lo agreg贸
  addedBy   User     @relation("GuestAddedBy", fields: [addedById], references: [id])
  createdAt DateTime @default(now())

  // Relaciones con gastos y deudas
  expensesPaid          Expense[] @relation("ExpensePaidByGuest")
  expenseParticipations GuestExpenseParticipant[]
  debtsOwed             GuestDebt[] @relation("GuestDebtFrom")
  debtsOwing            GuestDebt[] @relation("GuestDebtTo")
  giftEvents            Event[]   @relation("GiftRecipientGuest") // Eventos donde es el agasajado

  @@map("guest_members")
}

// ==================== EVENTOS ====================

enum EventType {
  GIFT      // Cumplea帽os/Regalo - oculto para el agasajado
  GATHERING // Juntada/Asado - visible para todos
}

model Event {
  id                    String       @id @default(cuid())
  groupId               String
  group                 Group        @relation(fields: [groupId], references: [id], onDelete: Cascade)
  name                  String
  type                  EventType
  date                  DateTime
  giftRecipientId       String?      // Solo para tipo GIFT (usuario)
  giftRecipient         User?        @relation("GiftRecipient", fields: [giftRecipientId], references: [id])
  giftRecipientGuestId  String?      // Solo para tipo GIFT (invitado)
  giftRecipientGuest    GuestMember? @relation("GiftRecipientGuest", fields: [giftRecipientGuestId], references: [id])
  isSettled             Boolean      @default(false)
  settledAt             DateTime?
  createdAt             DateTime     @default(now())
  updatedAt             DateTime     @updatedAt

  // Relaciones
  wishList   WishListItem[]
  expenses   Expense[]
  debts      Debt[]
  guestDebts GuestDebt[]

  @@map("events")
}

model WishListItem {
  id            String   @id @default(cuid())
  eventId       String
  event         Event    @relation(fields: [eventId], references: [id], onDelete: Cascade)
  description   String
  url           String?
  isPurchased   Boolean  @default(false)
  purchasedById String?
  purchasedBy   User?    @relation("WishListPurchasedBy", fields: [purchasedById], references: [id])
  createdAt     DateTime @default(now())

  @@map("wish_list_items")
}

// ==================== GASTOS ====================

model Expense {
  id              String       @id @default(cuid())
  eventId         String
  event           Event        @relation(fields: [eventId], references: [id], onDelete: Cascade)
  paidById        String?      // Usuario que pag贸 (opcional si pag贸 un invitado)
  paidBy          User?        @relation("ExpensePaidBy", fields: [paidById], references: [id])
  paidByGuestId   String?      // Invitado que pag贸 (opcional si pag贸 un usuario)
  paidByGuest     GuestMember? @relation("ExpensePaidByGuest", fields: [paidByGuestId], references: [id])
  amount          Float        // En pesos argentinos
  description     String
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt

  // Relaciones
  participants      ExpenseParticipant[]
  guestParticipants GuestExpenseParticipant[]
  debts             Debt[]
  guestDebts        GuestDebt[]

  @@map("expenses")
}

model ExpenseParticipant {
  id        String  @id @default(cuid())
  expenseId String
  expense   Expense @relation(fields: [expenseId], references: [id], onDelete: Cascade)
  userId    String
  user      User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([expenseId, userId])
  @@map("expense_participants")
}

// Participaci贸n de invitados en gastos
model GuestExpenseParticipant {
  id            String      @id @default(cuid())
  expenseId     String
  expense       Expense     @relation(fields: [expenseId], references: [id], onDelete: Cascade)
  guestMemberId String
  guestMember   GuestMember @relation(fields: [guestMemberId], references: [id], onDelete: Cascade)

  @@unique([expenseId, guestMemberId])
  @@map("guest_expense_participants")
}

// ==================== DEUDAS ====================

model Debt {
  id             String    @id @default(cuid())
  eventId        String
  event          Event     @relation(fields: [eventId], references: [id], onDelete: Cascade)
  expenseId      String
  expense        Expense   @relation(fields: [expenseId], references: [id], onDelete: Cascade)
  fromUserId     String    // Quien debe
  fromUser       User      @relation("DebtFrom", fields: [fromUserId], references: [id])
  toUserId       String    // A quien le deben
  toUser         User      @relation("DebtTo", fields: [toUserId], references: [id])
  amount         Float
  isPaid         Boolean   @default(false)
  paidAt         DateTime?
  markedPaidById String?   // Quien marc贸 como pagado
  markedPaidBy   User?     @relation("DebtMarkedPaidBy", fields: [markedPaidById], references: [id])
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  @@map("debts")
}

// Deudas de invitados (sin cuenta)
model GuestDebt {
  id              String       @id @default(cuid())
  eventId         String
  event           Event        @relation(fields: [eventId], references: [id], onDelete: Cascade)
  expenseId       String
  expense         Expense      @relation(fields: [expenseId], references: [id], onDelete: Cascade)
  fromUserId      String?      // Usuario que debe (si aplica)
  fromUser        User?        @relation("GuestDebtFromUser", fields: [fromUserId], references: [id])
  fromGuestId     String?      // Invitado que debe (si aplica)
  fromGuest       GuestMember? @relation("GuestDebtFrom", fields: [fromGuestId], references: [id])
  toGuestId       String?      // Invitado al que le deben (si aplica)
  toGuest         GuestMember? @relation("GuestDebtTo", fields: [toGuestId], references: [id])
  toUserId        String?      // Usuario al que le deben (el que pag贸)
  toUser          User?        @relation("GuestDebtToUser", fields: [toUserId], references: [id])
  amount          Float
  isPaid          Boolean      @default(false)
  paidAt          DateTime?
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt

  @@map("guest_debts")
}

// ==================== NOTIFICACIONES PUSH ====================

model PushToken {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  token     String   @unique // Token FCM
  device    String?  // Identificador del dispositivo (opcional)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("push_tokens")
}

// ==================== BILLETERAS (Control de gastos personales) ====================

enum WalletType {
  PERSONAL // Solo el creador
  SHARED   // Compartida (pareja, familia)
}

enum PersonalExpenseType {
  FIXED    // Fijo (alquiler, cuotas, suscripciones)
  VARIABLE // Variable (luz, gas, supermercado)
}

model Wallet {
  id          String     @id @default(cuid())
  name        String
  type        WalletType @default(PERSONAL)
  currency    String     @default("ARS") // ARS, USD, EUR, etc.
  inviteCode  String?    @unique // C贸digo para invitar miembros
  createdById String
  createdBy   User       @relation("WalletCreator", fields: [createdById], references: [id])
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt

  // Relaciones
  members       WalletMember[]
  expenses      PersonalExpense[]
  beneficiaries Beneficiary[]

  @@map("wallets")
}

// Beneficiarios/Dependientes de una billetera (mascota, hijo, auto, etc.)
model Beneficiary {
  id        String   @id @default(cuid())
  walletId  String
  wallet    Wallet   @relation(fields: [walletId], references: [id], onDelete: Cascade)
  name      String
  icon      String   @default("") // Emoji
  createdAt DateTime @default(now())

  // Relaciones
  expenses PersonalExpense[]

  @@map("beneficiaries")
}

model WalletMember {
  id       String   @id @default(cuid())
  walletId String
  wallet   Wallet   @relation(fields: [walletId], references: [id], onDelete: Cascade)
  userId   String
  user     User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  role     String   @default("MEMBER") // OWNER, MEMBER
  joinedAt DateTime @default(now())

  @@unique([walletId, userId])
  @@map("wallet_members")
}

// Categor铆as de gastos (algunas predeterminadas, otras personalizadas)
model ExpenseCategory {
  id        String   @id @default(cuid())
  name      String
  icon      String   // Emoji
  color     String   // Hex color
  isDefault Boolean  @default(false) // true = categor铆a global
  userId    String?  // null si es default, sino es del usuario
  user      User?    @relation("UserCategories", fields: [userId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())

  // Relaciones
  expenses PersonalExpense[]

  @@map("expense_categories")
}

// Gastos personales/familiares
model PersonalExpense {
  id            String              @id @default(cuid())
  walletId      String
  wallet        Wallet              @relation(fields: [walletId], references: [id], onDelete: Cascade)
  categoryId    String
  category      ExpenseCategory     @relation(fields: [categoryId], references: [id])
  beneficiaryId String?             // Opcional: para qui茅n es el gasto
  beneficiary   Beneficiary?        @relation(fields: [beneficiaryId], references: [id])
  amount        Float
  currency      String              @default("ARS") // Moneda del gasto
  exchangeRate  Float?              // Cotizaci贸n si es distinta a la billetera
  description   String
  date          DateTime
  type          PersonalExpenseType
  paidById      String
  paidBy       User                @relation("PersonalExpensePaidBy", fields: [paidById], references: [id])
  isRecurring  Boolean             @default(false)
  recurringId  String?             // ID del gasto recurrente padre
  createdAt    DateTime            @default(now())
  updatedAt    DateTime            @updatedAt

  @@map("personal_expenses")
}

// Plantillas de gastos recurrentes
model RecurringExpense {
  id          String              @id @default(cuid())
  walletId    String
  categoryId  String
  amount      Float
  currency    String              @default("ARS")
  description String
  dayOfMonth  Int                 // D铆a del mes (1-31)
  type        PersonalExpenseType
  isActive    Boolean             @default(true)
  createdAt   DateTime            @default(now())
  updatedAt   DateTime            @updatedAt

  @@map("recurring_expenses")
}

